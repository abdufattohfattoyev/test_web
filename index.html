<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Tizimi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 8px;
            color: #333;
            font-size: clamp(14px, 2.5vw, 16px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            font-size: clamp(1.2rem, 3.5vw, 1.8rem);
            font-weight: 700;
            margin-bottom: 8px;
        }

        .user-info {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: clamp(0.75rem, 2vw, 0.85rem);
            font-weight: 600;
            display: inline-block;
        }

        .page-description {
            font-size: clamp(0.75rem, 2vw, 0.9rem);
            color: #666;
        }

        .tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: clamp(0.7rem, 1.8vw, 0.8rem);
            text-align: center;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
        }

        .tab:hover:not(.active) {
            background: white;
            transform: translateY(-1px);
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 300px;
        }

        .loading, .empty-state {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: clamp(0.9rem, 2vw, 1rem);
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #c62828;
            margin: 8px 0;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .stat-number {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            font-weight: 700;
        }

        .stat-label {
            font-size: clamp(0.75rem, 2vw, 0.9rem);
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            border-color: #667eea;
            outline: none;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-success { background: linear-gradient(135deg, #28a745, #20c997); }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #fd7e14); }
        .btn-info { background: linear-gradient(135deg, #17a2b8, #20c997); }
        .btn-warning { background: linear-gradient(135deg, #ffc107, #fd7e14); color: #333; }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            margin: 8px 0;
        }

        .test-entry-form {
            max-width: 360px;
            margin: 0 auto;
            text-align: center;
        }

        .welcome-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
        }

        .data-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .table-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 8px;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f2f5;
        }

        .table-row:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .item-name { font-weight: 600; font-size: clamp(0.8rem, 2vw, 0.9rem); }
        .item-detail { font-size: clamp(0.7rem, 1.8vw, 0.8rem); color: #666; }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .score-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
        .score-high { background: #28a745; color: white; }
        .score-medium { background: #ffc107; color: #333; }
        .score-low { background: #dc3545; color: white; }
        .action-buttons { display: flex; gap: 4px; flex-wrap: wrap; }
        .action-btn { padding: 6px 8px; border-radius: 6px; font-size: 0.7rem; min-width: 50px; }

        .refresh-btn {
            position: fixed;
            bottom: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .refresh-btn:hover { transform: scale(1.1) rotate(180deg); }

        .admin-only, .student-only { display: none; }
        .compact-view { max-height: 350px; overflow-y: auto; }
        .compact-view::-webkit-scrollbar { width: 6px; }
        .compact-view::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .compact-view::-webkit-scrollbar-thumb { background: #667eea; border-radius: 3px; }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }

        .section-title {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            font-weight: 700;
        }

        .count-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .question-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .question-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .question-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
        }

        .answer-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .answer-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .answer-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .answer-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }

        .answer-status {
            font-size: clamp(0.7rem, 1.8vw, 0.8rem);
            color: #666;
            text-align: center;
            padding: 6px;
        }

        .save-section {
            background: #f8f9fa;
            border: 2px solid #667eea;
            text-align: center;
        }

        .save-progress {
            padding: 8px;
            font-weight: 600;
            color: #667eea;
        }

        @media (max-width: 768px) {
            body { padding: 4px; }
            .header, .content { padding: 12px; }
            .tabs { grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 6px; }
            .tab { padding: 8px; font-size: clamp(0.65rem, 1.8vw, 0.75rem); }
            .table-row { grid-template-columns: 1fr; text-align: center; }
            .action-buttons { justify-content: center; }
            .stats-grid, .form-grid { grid-template-columns: 1fr; }
            .btn { width: 100%; margin: 4px 0; }
            .refresh-btn { width: 40px; height: 40px; font-size: 1rem; }
            .compact-view { max-height: 300px; }
        }

        @media (max-width: 480px) {
            .header h1 { font-size: clamp(1rem, 3vw, 1.3rem); }
            .user-info { font-size: clamp(0.7rem, 1.8vw, 0.8rem); }
            .tabs { grid-template-columns: 1fr; }
            .tab { padding: 8px; font-size: clamp(0.7rem, 1.8vw, 0.8rem); }
            .card { padding: 10px; }
            .action-btn { padding: 6px; font-size: 0.7rem; }
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: clamp(0.7rem, 1.8vw, 0.8rem);
            white-space: nowrap;
            z-index: 1000;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in { animation: fadeInUp 0.4s ease forwards; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header fade-in">
            <h1 id="pageTitle">üìä Test Tizimi</h1>
            <div class="user-info" id="userInfo">Yuklanmoqda...</div>
            <p class="page-description" id="pageDescription">Test tizimiga xush kelibsiz</p>
        </div>

        <div id="studentLogin" class="student-only fade-in">
            <div class="content">
                <div class="welcome-message">
                    <h2>üéì Test Topshirish</h2>
                    <p>Test kodini va ma'lumotlaringizni kiriting</p>
                </div>
                <div class="test-entry-form">
                    <div class="form-group">
                        <label for="testCodeInput" class="form-label">Test Kodi:</label>
                        <input type="text" id="testCodeInput" class="form-input" placeholder="TEST001" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label for="studentName" class="form-label">Ism Familiyangiz:</label>
                        <input type="text" id="studentName" class="form-input" placeholder="Ism va familiya">
                    </div>
                    <button onclick="startTest()" class="btn btn-success">üöÄ Testni Boshlash</button>
                </div>
            </div>
        </div>

        <div id="adminTabs" class="admin-only fade-in">
            <div class="tabs">
                <button class="tab active" onclick="showTab('dashboard')" data-tooltip="Umumiy statistika">üìä Dashboard</button>
                <button class="tab" onclick="showTab('admin')" data-tooltip="Yangi test yaratish">‚ûï Yaratish</button>
                <button class="tab" onclick="showTab('users')" data-tooltip="Foydalanuvchilar">üë• Users</button>
                <button class="tab" onclick="showTab('tests')" data-tooltip="Yaratilgan testlar">üìù Testlar</button>
                <button class="tab" onclick="showTab('students')" data-tooltip="Test topshirganlar">üéì Students</button>
                <button class="tab" onclick="showTab('results')" data-tooltip="Natijalar">üìà Natijalar</button>
            </div>
        </div>

        <div id="adminContent" class="admin-only fade-in">
            <div class="content">
                <div id="dashboard" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">üìä Umumiy Statistika</h2>
                        <button onclick="loadDashboard()" class="btn" data-tooltip="Yangilash">üîÑ</button>
                    </div>
                    <div class="stats-grid" id="statsGrid">
                        <div class="loading">üìä Yuklanmoqda...</div>
                    </div>
                </div>

                <div id="admin" class="tab-content" style="display:none;">
                    <div class="section-header">
                        <h2 class="section-title">‚ûï Test Yaratish</h2>
                    </div>
                    <div class="card" id="createTestForm">
                        <h3>Yangi Test</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="testCode" class="form-label">Test Kodi:</label>
                                <input type="text" id="testCode" class="form-input" placeholder="TEST001" style="text-transform: uppercase;">
                            </div>
                            <div class="form-group">
                                <label for="testTitle" class="form-label">Test Nomi:</label>
                                <input type="text" id="testTitle" class="form-input" placeholder="Test nomi">
                            </div>
                            <div class="form-group">
                                <label for="openCount" class="form-label">Ochiq Savollar:</label>
                                <input type="number" id="openCount" class="form-input" min="0" max="50" value="0">
                            </div>
                            <div class="form-group">
                                <label for="closedCount" class="form-label">Yopiq Savollar:</label>
                                <input type="number" id="closedCount" class="form-input" min="0" max="50" value="0">
                            </div>
                        </div>
                        <button onclick="createTest()" class="btn">‚ûï Test Yaratish</button>
                    </div>
                    <div class="card" id="answersSection" style="display: none;">
                        <h3>üìù Javoblar Kiritish</h3>
                        <div id="answersContent"></div>
                    </div>
                    <div class="card">
                        <h3>üîß Test Boshqaruv</h3>
                        <div class="form-grid">
                            <button onclick="loadActiveTests()" class="btn btn-success">üìù Faol Testlar</button>
                            <button onclick="loadInactiveTests()" class="btn btn-warning">üö´ Nofaol Testlar</button>
                            <button onclick="exportResults()" class="btn btn-info">üìä Barcha Natijalarni Eksport</button>
                            <button onclick="clearOldData()" class="btn btn-danger">üóëÔ∏è Tozalash</button>
                        </div>
                        <div id="testManagement"></div>
                    </div>
                </div>

                <div id="users" class="tab-content" style="display:none;">
                    <div class="section-header">
                        <h2 class="section-title">üë• Foydalanuvchilar</h2>
                        <div class="count-badge" id="usersCount">0</div>
                    </div>
                    <div id="usersList" class="compact-view"></div>
                </div>

                <div id="tests" class="tab-content" style="display:none;">
                    <div class="section-header">
                        <h2 class="section-title">üìù Testlar</h2>
                        <div class="count-badge" id="testsCount">0</div>
                    </div>
                    <div id="testsList" class="compact-view"></div>
                </div>

                <div id="students" class="tab-content" style="display:none;">
                    <div class="section-header">
                        <h2 class="section-title">üéì O'quvchilar</h2>
                        <div class="count-badge" id="studentsCount">0</div>
                    </div>
                    <div id="studentsList" class="compact-view"></div>
                </div>

                <div id="results" class="tab-content" style="display:none;">
                    <div class="section-header">
                        <h2 class="section-title">üìà Natijalar</h2>
                        <div class="count-badge" id="resultsCount">0</div>
                    </div>
                    <div id="resultsList" class="compact-view"></div>
                </div>
            </div>
        </div>
    </div>

    <button class="refresh-btn" onclick="loadAllData()" data-tooltip="Yangilash">üîÑ</button>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://jwkgrkvornagxauwrduq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3a2dya3Zvcm5hZ3hhdXdyZHVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwOTM4NDcsImV4cCI6MjA2OTY2OTg0N30.LOF8n-jJKzm9DcTTWu4QYrqWf7x7zLd3m29BlP8-n1I';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null, isAdmin = false, currentTab = 'dashboard';

        const showLoading = (id, msg = 'Yuklanmoqda...') => document.getElementById(id).innerHTML = `<div class="loading">${msg}</div>`;
        const showError = (id, msg) => document.getElementById(id).innerHTML = `<div class="error">‚ùå ${msg}</div>`;
        const showEmpty = (id, icon, msg) => document.getElementById(id).innerHTML = `<div class="empty-state"><div class="empty-state-icon">${icon}</div><p>${msg}</p></div>`;
        const formatDate = (date) => new Date(date).toLocaleDateString('uz-UZ', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        const getUserIdFromUrl = () => new URLSearchParams(window.location.search).get('user_id');

        async function checkUserRole() {
            const userId = getUserIdFromUrl();
            if (!userId) return showStudentInterface();

            showLoading('userInfo');
            try {
                const { data: user, error } = await supabase.from('users').select('*').eq('telegram_id', userId).single();
                if (error || !user) return showStudentInterface();

                currentUser = user;
                isAdmin = user.is_admin;
                isAdmin ? showAdminInterface() : showStudentInterface();
            } catch (error) {
                console.error('Rol tekshirishda xato:', error);
                showStudentInterface();
            }
        }

        function showAdminInterface() {
            document.getElementById('adminTabs').style.display = 'block';
            document.getElementById('adminContent').style.display = 'block';
            document.getElementById('studentLogin').style.display = 'none';
            document.getElementById('pageTitle').textContent = 'üìä Admin Panel';
            document.getElementById('userInfo').textContent = `Admin: ${currentUser.full_name || currentUser.first_name}`;
            document.getElementById('pageDescription').textContent = 'Testlar va natijalar boshqaruvi';
            loadAllData();
        }

        function showStudentInterface() {
            document.getElementById('adminTabs').style.display = 'none';
            document.getElementById('adminContent').style.display = 'none';
            document.getElementById('studentLogin').style.display = 'block';
            document.getElementById('pageTitle').textContent = 'üéì Test Tizimi';
            document.getElementById('userInfo').textContent = currentUser ? currentUser.full_name || currentUser.first_name : 'Mehmon';
            document.getElementById('pageDescription').textContent = 'Test topshirish uchun ma\'lumotlaringizni kiriting';
        }

        async function startTest() {
            const testCode = document.getElementById('testCodeInput').value.trim().toUpperCase();
            const studentName = document.getElementById('studentName').value.trim();

            if (!testCode || testCode.length < 3 || !studentName || studentName.length < 3) {
                alert('‚ùå Test kodi va ism-familiyani to\'g\'ri kiriting!');
                return;
            }

            try {
                const { data: test, error: testError } = await supabase.from('tests').select('*').eq('code', testCode).eq('is_active', true).single();
                if (testError || !test) return alert('‚ùå Test topilmadi yoki faol emas!');

                const { data: student, error: studentError } = await supabase.from('students').insert([{
                    telegram_id: currentUser?.telegram_id || null,
                    full_name: studentName,
                    test_code: testCode,
                    total_questions: test.open_questions_count + test.closed_questions_count
                }]).select().single();

                if (studentError) throw studentError;
                alert('‚úÖ Test muvaffaqiyatli boshlandi!');
            } catch (error) {
                console.error('Test boshlashda xato:', error);
                alert('‚ùå Testni boshlashda xatolik!');
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            currentTab = tabName;

            const actions = {
                dashboard: loadDashboard,
                users: loadUsers,
                tests: loadTests,
                students: loadStudents,
                results: loadResults
            };
            actions[tabName]?.();
        }

        async function loadDashboard() {
            if (!isAdmin) return;
            showLoading('statsGrid');
            try {
                const [users, tests, students, activeTests] = await Promise.all([
                    supabase.from('users').select('id', { count: 'exact' }),
                    supabase.from('tests').select('id', { count: 'exact' }),
                    supabase.from('students').select('id', { count: 'exact' }),
                    supabase.from('tests').select('id', { count: 'exact' }).eq('is_active', true)
                ]);

                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card fade-in"><div class="stat-number">${users.count || 0}</div><div class="stat-label">üë• Foydalanuvchilar</div></div>
                    <div class="stat-card fade-in"><div class="stat-number">${tests.count || 0}</div><div class="stat-label">üìù Jami Testlar</div></div>
                    <div class="stat-card fade-in"><div class="stat-number">${activeTests.count || 0}</div><div class="stat-label">‚úÖ Faol Testlar</div></div>
                    <div class="stat-card fade-in"><div class="stat-number">${students.count || 0}</div><div class="stat-label">üéì O'quvchilar</div></div>
                `;
            } catch (error) {
                console.error('Dashboard xatosi:', error);
                showError('statsGrid', 'Statistika yuklanmadi');
            }
        }

        async function loadUsers() {
            if (!isAdmin) return;
            showLoading('usersList');
            try {
                const { data: users, error, count } = await supabase.from('users').select('*', { count: 'exact' }).order('created_at', { ascending: false }).limit(50);
                document.getElementById('usersCount').textContent = count || 0;
                if (error) throw error;
                if (!users.length) return showEmpty('usersList', 'üë•', 'Foydalanuvchilar yo\'q');

                document.getElementById('usersList').innerHTML = users.map(user => `
                    <div class="data-table">
                        <div class="table-row">
                            <div><div class="item-name">${user.full_name || (user.first_name + ' ' + (user.last_name || ''))}</div><div class="item-detail">@${user.username || 'Noma\'lum'} ‚Ä¢ ID: ${user.telegram_id}</div></div>
                            <div class="status-badge ${user.is_admin ? 'status-active' : 'status-inactive'}">${user.is_admin ? 'Admin' : 'User'}</div>
                            <div class="item-detail">${formatDate(user.created_at)}</div>
                            <div class="action-buttons"><button class="action-btn btn-info" onclick="viewUserDetails('${user.telegram_id}')">üëÅÔ∏è</button></div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Foydalanuvchilar xatosi:', error);
                showError('usersList', 'Foydalanuvchilar yuklanmadi');
            }
        }

        async function loadTests() {
            if (!isAdmin) return;
            showLoading('testsList');
            try {
                const { data: tests, error, count } = await supabase.from('tests').select('*, users!tests_admin_id_fkey(full_name, first_name), students(count)', { count: 'exact' }).order('created_at', { ascending: false }).limit(50);
                document.getElementById('testsCount').textContent = count || 0;
                if (error) throw error;
                if (!tests.length) return showEmpty('testsList', 'üìù', 'Testlar yo\'q');

                document.getElementById('testsList').innerHTML = tests.map(test => {
                    const adminName = test.users?.full_name || test.users?.first_name || 'Noma\'lum';
                    return `
                        <div class="data-table">
                            <div class="table-row">
                                <div><div class="item-name">${test.code} - ${test.title}</div><div class="item-detail">Admin: ${adminName} ‚Ä¢ O:${test.open_questions_count}, Y:${test.closed_questions_count} ‚Ä¢ Ishtirokchilar: ${test.students?.count || 0}</div></div>
                                <div class="status-badge ${test.is_active ? 'status-active' : 'status-inactive'}">${test.is_active ? 'Faol' : 'Nofaol'}</div>
                                <div class="item-detail">${formatDate(test.created_at)}</div>
                                <div class="action-buttons">
                                    <button class="action-btn ${test.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleTestStatus(${test.id}, ${!test.is_active})">${test.is_active ? 'üö´' : '‚úÖ'}</button>
                                    <button class="action-btn btn-info" onclick="viewTestDetails(${test.id})">üëÅÔ∏è</button>
                                    <button class="action-btn btn-info" onclick="viewTestParticipants('${test.code}')">üë•</button>
                                    <button class="action-btn btn-info" onclick="exportResults('${test.code}')">üìä</button>
                                    <button class="action-btn btn-danger" onclick="deleteTest(${test.id})">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Testlar xatosi:', error);
                showError('testsList', 'Testlar yuklanmadi');
            }
        }

        async function loadStudents() {
            if (!isAdmin) return;
            showLoading('studentsList');
            try {
                const { data: students, error, count } = await supabase.from('students').select('*, tests(title)', { count: 'exact' }).order('started_at', { ascending: false }).limit(100);
                document.getElementById('studentsCount').textContent = count || 0;
                if (error) throw error;
                if (!students.length) return showEmpty('studentsList', 'üéì', 'O\'quvchilar yo\'q');

                document.getElementById('studentsList').innerHTML = students.map(student => {
                    const scoreClass = student.percentage >= 80 ? 'score-high' : student.percentage >= 60 ? 'score-medium' : 'score-low';
                    return `
                        <div class="data-table">
                            <div class="table-row">
                                <div><div class="item-name">${student.full_name}</div><div class="item-detail">${student.tests?.title || 'Noma\'lum'} (${student.test_code})</div></div>
                                <div class="score-badge ${scoreClass}">${student.score || 0}/${student.total_questions}</div>
                                <div class="score-badge ${scoreClass}">${student.percentage || 0}%</div>
                                <div class="item-detail">${formatDate(student.started_at)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('O\'quvchilar xatosi:', error);
                showError('studentsList', 'O\'quvchilar yuklanmadi');
            }
        }

        async function loadResults() {
            if (!isAdmin) return;
            showLoading('resultsList');
            try {
                const { data: results, error, count } = await supabase.from('students').select('*, tests(title, code)', { count: 'exact' }).not('completed_at', 'is', null).order('completed_at', { ascending: false }).limit(100);
                document.getElementById('resultsCount').textContent = count || 0;
                if (error) throw error;
                if (!results.length) return showEmpty('resultsList', 'üìà', 'Natijalar yo\'q');

                document.getElementById('resultsList').innerHTML = results.map(result => {
                    const scoreClass = result.percentage >= 80 ? 'score-high' : result.percentage >= 60 ? 'score-medium' : 'score-low';
                    return `
                        <div class="card">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; align-items: center;">
                                <div><div class="item-name">${result.full_name}</div><div class="item-detail">${result.tests?.title} (${result.test_code})</div><div class="item-detail">Tugatilgan: ${formatDate(result.completed_at)}</div></div>
                                <div class="score-badge ${scoreClass}">${result.score}/${result.total_questions}</div>
                                <div class="score-badge ${scoreClass}">${result.percentage}%</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Natijalar xatosi:', error);
                showError('resultsList', 'Natijalar yuklanmadi');
            }
        }

        async function createTest() {
            if (!isAdmin) return alert('‚ùå Test yaratish huquqingiz yo\'q!');

            const code = document.getElementById('testCode').value.trim().toUpperCase();
            const title = document.getElementById('testTitle').value.trim();
            const openCount = parseInt(document.getElementById('openCount').value) || 0;
            const closedCount = parseInt(document.getElementById('closedCount').value) || 0;

            if (!code || code.length < 3 || !title || title.length < 3 || openCount + closedCount === 0) {
                return alert('‚ùå Test kodi, nomi yoki savollar sonini to\'g\'ri kiriting!');
            }

            try {
                const { data: existingTest } = await supabase.from('tests').select('*').eq('code', code).single();
                if (existingTest) return alert('‚ùå Bu kod allaqachon mavjud!');

                const { data: testData, error } = await supabase.from('tests').insert([{
                    code, title, admin_id: currentUser.telegram_id, open_questions_count: openCount, closed_questions_count: closedCount, is_active: false
                }]).select().single();

                if (error) throw error;

                document.getElementById('createTestForm').innerHTML = `
                    <div class="success-message">
                        <h3>‚úÖ Test yaratildi!</h3>
                        <p><strong>Kod:</strong> ${code}</p>
                        <p><strong>Nom:</strong> ${title}</p>
                        <p><strong>Ochiq/Yopiq:</strong> ${openCount}/${closedCount}</p>
                        <button onclick="location.reload()" class="btn">üîÑ Yangi Test</button>
                    </div>
                `;
                showAnswersSection(testData.id, openCount, closedCount);
            } catch (error) {
                console.error('Test yaratish xatosi:', error);
                alert('‚ùå Test yaratishda xatolik!');
            }
        }

        function showAnswersSection(testId, openCount, closedCount) {
            const answersSection = document.getElementById('answersSection');
            answersSection.style.display = 'block';
            document.getElementById('admin').scrollIntoView({ behavior: 'smooth' });

            let html = '';
            window.testAnswers = {};

            if (closedCount > 0) {
                html += `<div class="card"><h4>üìã Yopiq Savollar (${closedCount})</h4>`;
                for (let i = 1; i <= closedCount; i++) {
                    html += `
                        <div class="question-card" id="closed-${i}">
                            <div class="question-header"><span class="question-number">${i}</span><span class="question-label">-savol javobi:</span></div>
                            <div class="answer-options">
                                ${['A', 'B', 'C', 'D'].map(opt => `<button class="answer-btn" onclick="selectAnswer('closed', ${i}, '${opt}')" data-answer="${opt}">${opt}</button>`).join('')}
                            </div>
                            <div class="answer-status" id="status-closed-${i}">Javobni tanlang</div>
                        </div>`;
                }
                html += '</div>';
            }

            if (openCount > 0) {
                html += `<div class="card"><h4>üìñ Ochiq Savollar (${openCount})</h4>`;
                for (let i = 1; i <= openCount; i++) {
                    html += `
                        <div class="question-card" id="open-${i}">
                            <div class="question-header"><span class="question-number">${i}</span><span class="question-label">-savol javobi:</span></div>
                            <input type="text" id="openAnswer${i}" class="answer-input" placeholder="Javobni kiriting..." onchange="selectOpenAnswer(${i}, this.value)">
                            <div class="answer-status" id="status-open-${i}">Javobni kiriting</div>
                        </div>`;
                }
                html += '</div>';
            }

            html += `
                <div class="card save-section">
                    <div class="save-progress"><span id="answeredCount">0</span> / <span id="totalCount">${openCount + closedCount}</span> javob kiritildi</div>
                    <button onclick="saveAllAnswers(${testId})" class="btn btn-success save-all-btn" disabled>üíæ Saqlash</button>
                </div>
            `;
            document.getElementById('answersContent').innerHTML = html;
        }

        function selectAnswer(type, questionNumber, answer) {
            const questionId = `${type}-${questionNumber}`;
            document.querySelectorAll(`#${questionId} .answer-btn`).forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#${questionId} .answer-btn[data-answer="${answer}"]`).classList.add('active');
            window.testAnswers[`${type}_${questionNumber}`] = answer;
            document.getElementById(`status-${questionId}`).textContent = `‚úÖ Tanlandi: ${answer}`;
            document.getElementById(`status-${questionId}`).style.color = '#28a745';
            updateSaveButton();
        }

        function selectOpenAnswer(questionNumber, answer) {
            const statusElement = document.getElementById(`status-open-${questionNumber}`);
            if (answer.trim()) {
                window.testAnswers[`open_${questionNumber}`] = answer.trim();
                statusElement.textContent = `‚úÖ Kiritildi`;
                statusElement.style.color = '#28a745';
            } else {
                delete window.testAnswers[`open_${questionNumber}`];
                statusElement.textContent = `Javobni kiriting`;
                statusElement.style.color = '#666';
            }
            updateSaveButton();
        }

        function updateSaveButton() {
            const total = parseInt(document.getElementById('totalCount').textContent);
            const answered = Object.keys(window.testAnswers).length;
            document.getElementById('answeredCount').textContent = answered;
            const saveButton = document.querySelector('.save-all-btn');
            saveButton.disabled = answered !== total;
            saveButton.innerHTML = answered === total ? 'üíæ Saqlash' : `üíæ Saqlash (${answered}/${total})`;
        }

        async function saveAllAnswers(testId) {
            if (!window.testAnswers || !Object.keys(window.testAnswers).length) return alert('‚ùå Javoblar topilmadi!');
            if (!confirm(`${Object.keys(window.testAnswers).length} ta javob saqlanadi. Tasdiqlaysizmi?`)) return;

            try {
                document.querySelector('.save-all-btn').innerHTML = '‚è≥ Saqlanmoqda...';
                document.querySelector('.save-all-btn').disabled = true;

                const insertData = Object.entries(window.testAnswers).map(([key, value]) => {
                    const [type, questionNumber] = key.split('_');
                    return { test_id: testId, question_number: parseInt(questionNumber), question_type: type, correct_answer: value };
                });

                await supabase.from('test_answers').delete().eq('test_id', testId);
                const { error } = await supabase.from('test_answers').insert(insertData);
                if (error) throw error;

                document.querySelectorAll('.question-card').forEach(card => {
                    card.style.borderLeft = '4px solid #28a745';
                    card.style.background = '#d4edda';
                });

                document.querySelector('.save-all-btn').innerHTML = '‚úÖ Saqlandi';
                document.querySelector('.save-all-btn').style.background = '#28a745';
                setTimeout(() => {
                    document.querySelector('.save-section').innerHTML += `<button onclick="finishTestCreation(${testId})" class="btn btn-success">üöÄ Faollashtirish</button>`;
                }, 1000);
            } catch (error) {
                console.error('Javob saqlash xatosi:', error);
                alert('‚ùå Javob saqlashda xatolik!');
                document.querySelector('.save-all-btn').innerHTML = 'üíæ Saqlash';
                document.querySelector('.save-all-btn').disabled = false;
            }
        }

        async function finishTestCreation(testId) {
            try {
                const [test, answers] = await Promise.all([
                    supabase.from('tests').select('*').eq('id', testId).single(),
                    supabase.from('test_answers').select('*').eq('test_id', testId)
                ]);

                if (!test.data || answers.data.length < (test.data.open_questions_count + test.data.closed_questions_count)) {
                    return alert(`‚ùå Barcha javoblarni kiriting! (${answers.data.length}/${test.data.open_questions_count + test.data.closed_questions_count})`);
                }

                const { error } = await supabase.from('tests').update({ is_active: true }).eq('id', testId);
                if (error) throw error;

                alert('üéâ Test faollashtirildi!');
                location.reload();
            } catch (error) {
                console.error('Test faollashtirish xatosi:', error);
                alert('‚ùå Xatolik!');
            }
        }

        async function toggleTestStatus(testId, isActive) {
lieresult, answersResult, studentsResult] = await Promise.all([
                    supabase.from('tests').select('*').eq('id', testId).single(),
                    supabase.from('test_answers').select('*').eq('test_id', testId),
                    supabase.from('students').select('*').eq('test_code', test.code).limit(10)
                ]);

                const test = testResult.data;
                const answers = answersResult.data || [];
                const students = studentsResult.data || [];

                let detailsHtml = `
                    <div class="card">
                        <h4>üìã Test: ${test.code}</h4>
                        <div class="form-grid">
                            <p><strong>Nom:</strong> ${test.title}</p>
                            <p><strong>Status:</strong> ${test.is_active ? '‚úÖ Faol' : '‚ùå Nofaol'}</p>
                            <p><strong>Savollar:</strong> O:${test.open_questions_count}, Y:${test.closed_questions_count}</p>
                            <p><strong>Javoblar:</strong> ${answers.length} ta</p>
                            <p><strong>Ishtirokchilar:</strong> ${students.length} ta</p>
                        </div>
                `;

                if (answers.length > 0) {
                    detailsHtml += '<h5>üìù Javoblar:</h5><div class="form-grid">';
                    answers.forEach(answer => {
                        detailsHtml += `<p>${answer.question_type} ${answer.question_number}: <strong>${answer.correct_answer}</strong></p>`;
                    });
                    detailsHtml += '</div>';
                }

                if (students.length > 0) {
                    detailsHtml += '<h5>üë• Ishtirokchilar:</h5><div class="form-grid">';
                    students.forEach(student => {
                        detailsHtml += `<p>${student.full_name} (${student.percentage || 0}%)</p>`;
                    });
                    detailsHtml += '</div>';
                }

                detailsHtml += '<button onclick="loadTests()" class="btn">‚óÄÔ∏è Orqaga</button></div>';
                document.getElementById('testsList').innerHTML = detailsHtml;
            } catch (error) {
                console.error('Test tafsilotlari xatosi:', error);
                alert('‚ùå Xatolik!');
            }
        }

        async function viewUserDetails(userId) {
            try {
                const { data: user, error } = await supabase.from('users').select('*').eq('telegram_id', userId).single();
                if (error || !user) return alert('‚ùå Foydalanuvchi topilmadi!');

                document.getElementById('usersList').innerHTML = `
                    <div class="card">
                        <h4>üë§ ${user.full_name || (user.first_name + ' ' + (user.last_name || ''))}</h4>
                        <div class="form-grid">
                            <p><strong>Telegram ID:</strong> ${user.telegram_id}</p>
                            <p><strong>Username:</strong> @${user.username || 'Noma\'lum'}</p>
                            <p><strong>Rol:</strong> ${user.is_admin ? 'üë®‚Äçüíº Admin' : 'üë§ Foydalanuvchi'}</p>
                            <p><strong>Ro'yxatdan o'tgan:</strong> ${formatDate(user.created_at)}</p>
                        </div>
                        <button onclick="loadUsers()" class="btn">‚óÄÔ∏è Orqaga</button>
                    </div>
                `;
            } catch (error) {
                console.error('Foydalanuvchi tafsilotlari xatosi:', error);
                alert('‚ùå Xatolik!');
            }
        }

        async function loadActiveTests() {
            try {
                const { data: tests, error } = await supabase.from('tests').select('*').eq('is_active', true).order('created_at', { ascending: false });
                if (error) throw error;
                displayTestManagement(tests, 'Faol Testlar', 'success');
            } catch (error) {
                console.error('Faol testlar xatosi:', error);
                showError('testManagement', 'Faol testlar yuklanmadi');
            }
        }

        async function loadInactiveTests() {
            try {
                const { data: tests, error } = await supabase.from('tests').select('*').eq('is_active', false).order('created_at', { ascending: false });
                if (error) throw error;
                displayTestManagement(tests, 'Nofaol Testlar', 'warning');
            } catch (error) {
                console.error('Nofaol testlar xatosi:', error);
                showError('testManagement', 'Nofaol testlar yuklanmadi');
            }
        }

        function displayTestManagement(tests, title, type) {
            const container = document.getElementById('testManagement');
            if (!tests.length) return container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>${title} yo'q</p></div>`;

            container.innerHTML = `
                <div class="section-header"><h4 class="section-title">${title}</h4><div class="count-badge">${tests.length}</div></div>
                ${tests.map(test => `
                    <div class="data-table">
                        <div class="table-row">
                            <div><div class="item-name">${test.code} - ${test.title}</div><div class="item-detail">O:${test.open_questions_count}, Y:${test.closed_questions_count} ‚Ä¢ ${formatDate(test.created_at)}</div></div>
                            <div class="status-badge ${test.is_active ? 'status-active' : 'status-inactive'}">${test.is_active ? 'Faol' : 'Nofaol'}</div>
                            <div class="action-buttons">
                                <button class="action-btn ${test.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleTestStatus(${test.id}, ${!test.is_active})">${test.is_active ? 'üö´' : '‚úÖ'}</button>
                                <button class="action-btn btn-info" onclick="viewTestDetails(${test.id})">üëÅÔ∏è</button>
                                <button class="action-btn btn-info" onclick="viewTestParticipants('${test.code}')">üë•</button>
                                <button class="action-btn btn-info" onclick="exportResults('${test.code}')">üìä</button>
                                <button class="action-btn btn-danger" onclick="deleteTest(${test.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        async function exportResults(testCode = '') {
            try {
                const confirmMessage = testCode ? `"${testCode.toUpperCase()}" natijalarini eksport qilishni tasdiqlaysizmi?` : 'Barcha natijalarni eksport qilishni tasdiqlaysizmi?';
                if (!confirm(confirmMessage)) return;

                showLoading('resultsList', 'üìä Eksport qilinmoqda...');
                let query = supabase.from('students').select('*, tests(title, code)').not('completed_at', 'is', null).order('completed_at', { ascending: false });
                if (testCode) query = query.eq('test_code', testCode.toUpperCase());

                const { data: results, error } = await query;
                if (error) throw error;
                if (!results.length) {
                    alert('üì≠ Natijalar topilmadi!');
                    loadResults();
                    return;
                }

                const BOM = '\uFEFF';
                let csv = BOM + 'T/r,Ism Familiya,Test Nomi,Test Kodi,To\'g\'ri Javoblar,Jami Savollar,Ball (%),Boshlangan Sana,Tugatilgan Sana\n';
                results.forEach((result, index) => {
                    const startDate = new Date(result.started_at).toLocaleDateString('uz-UZ');
                    const endDate = result.completed_at ? new Date(result.completed_at).toLocaleDateString('uz-UZ') : '';
                    csv += `${index + 1},"${result.full_name}","${result.tests?.title || 'Noma\'lum'}","${result.test_code}",${result.score || 0},${result.total_questions},${result.percentage || 0}%,${startDate},${endDate}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', testCode ? `${testCode.toUpperCase()}_natijalar.csv` : 'barcha_natijalar.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                alert(`‚úÖ ${results.length} ta natija eksport qilindi!`);
                loadResults();
            } catch (error) {
                console.error('Eksport xatosi:', error);
                alert('‚ùå Eksport qilishda xatolik!');
                loadResults();
            }
        }

        async function clearOldData() {
            if (prompt('‚ö†Ô∏è 30 kundan eski ma\'lumotlarni o\'chirish uchun "DELETE" kiriting:') !== 'DELETE') return alert('‚ùå Bekor qilindi!');

            try {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const { error } = await supabase.from('students').delete().lt('created_at', thirtyDaysAgo.toISOString());
                if (error) throw error;
                alert('‚úÖ Eski ma\'lumotlar o\'chirildi!');
                loadAllData();
            } catch (error) {
                console.error('O\'chirish xatosi:', error);
                alert('‚ùå Xatolik!');
            }
        }

        async function loadAllData() {
            if (!isAdmin) return;
            const actions = { dashboard: loadDashboard, users: loadUsers, tests: loadTests, students: loadStudents, results: loadResults };
            await actions[currentTab]?.();
        }

        async function viewTestParticipants(testCode) {
            try {
                showLoading('testsList', 'üë• Ishtirokchilar yuklanmoqda...');
                const { data: students, error } = await supabase.from('students').select('*, tests(title)').eq('test_code', testCode).order('started_at', { ascending: false });
                if (error) throw error;
                if (!students.length) return showEmpty('testsList', 'üë•', 'Ishtirokchilar yo\'q');

                document.getElementById('testsList').innerHTML = `
                    <div class="section-header"><h4 class="section-title">üë• ${testCode} - Ishtirokchilar</h4><div class="count-badge">${students.length}</div></div>
                    ${students.map(student => `
                        <div class="data-table">
                            <div class="table-row">
                                <div><div class="item-name">${student.full_name}</div><div class="item-detail">${student.tests?.title || 'Noma\'lum'} (${student.test_code})</div></div>
                                <div class="score-badge ${student.percentage >= 80 ? 'score-high' : student.percentage >= 60 ? 'score-medium' : 'score-low'}">${student.score || 0}/${student.total_questions}</div>
                                <div class="score-badge ${student.percentage >= 80 ? 'score-high' : student.percentage >= 60 ? 'score-medium' : 'score-low'}">${student.percentage || 0}%</div>
                                <div class="item-detail">${formatDate(student.started_at)}</div>
                            </div>
                        </div>
                    `).join('')}
                    <button onclick="loadTests()" class="btn">‚óÄÔ∏è Orqaga</button>
                `;
            } catch (error) {
                console.error('Ishtirokchilar xatosi:', error);
                showError('testsList', 'Ishtirokchilar yuklanmadi');
            }
        }

        function setupRealtimeUpdates() {
            if (!isAdmin) return;
            supabase.channel('students_changes').on('postgres_changes', { event: '*', schema: 'public', table: 'students' }, () => {
                if (['students', 'results'].includes(currentTab)) setTimeout(() => { if (currentTab === 'students') loadStudents(); if (currentTab === 'results') loadResults(); }, 1000);
            }).subscribe();
            supabase.channel('tests_changes').on('postgres_changes', { event: '*', schema: 'public', table: 'tests' }, () => {
                if (['tests', 'dashboard'].includes(currentTab)) setTimeout(() => { if (currentTab === 'tests') loadTests(); if (currentTab === 'dashboard') loadDashboard(); }, 1000);
            }).subscribe();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await checkUserRole();
            if (isAdmin) {
                setupRealtimeUpdates();
                setInterval(() => document.visibilityState === 'visible' && loadAllData(), 300000);
            }
        });

        window.addEventListener('beforeunload', () => supabase.removeAllChannels());
    </script>
</body>
</html>